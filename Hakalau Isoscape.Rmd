---
title: "Hakalau Isoscape"
author: "CB Wall"
date: "9/11/2019"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options: 
  chunk_output_type: inline
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
require("knitr")
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# load packages
suppressPackageStartupMessages({
library("RgoogleMaps")
library("SDMTools")
library("rgdal")
library("ggmap")
library("gridExtra")
library("cowplot")
library("sp")
library("gstat")
library("plotrix")
library("dplyr") # for "glimpse"
library("ggplot2")
library("scales") # for "comma"
library("magrittr")
library("plyr")
})
```

## Background  
**Hakalau National Forest Wildlife Refuge Isoscapes**  
Data collected 20-21 August 2019 in Hakalau Forest, Hawai'i Island. Soil and plant samples collected from remnant ko forests (*RK sites*) and those afforested/planted after a century of deforestation from cattle grazing (*AK sites*). Target engineers of forest habitats are *Acacia koa* (common name: koa), an indigenous hardwood species that forms native forest canopies and associates with nitrogen fixing bacteria. Understory species include *Rubus argutus* -- an invasive species (common name: sawtooth blackberry) -- and an endemic species *Rubus hawaiiensis* (common name: 'Ākala); both are members of the Roseaceae family. Noteably, *R. argutus* was found more in the remnant plot (i.e., RK) and the indigenous *R. hawaiiensis* was common in the restored plot (i.e, AK). 

Soil samples were collected in a spatially explicit fashion (every 4 or 5m) with a 20 x 35m superplot, consisting of thirty-five 4 x 5m subplots. This data was used to create a δ^13^C and δ^15^N stable isotope landscape, hereafter 'isoscape'. Koa and *Rubus* spp. were collected within each 4 x 5m sublot.


### Site Maps
```{r, site maps}

# load data
Hak.gps<-read.csv("data/Hakalau.gps.csv")
API<-read.csv("data/API_key.csv")
API.key<-API[1,1]

ggplot(Hak.gps, aes(x = longitude, y = latitude)) +
  coord_quickmap() +
  geom_point()

######## using ggmap
register_google(key=API.key)

Hak.rev=c(-155.317, 19.82158002)
map2<-get_map(Hak.rev, 
                      zoom=17, 
                      scale = 2, 
                      maptype= "satellite",
                      source="google", extent= "device", legend="topright")

png(file= "figures/sitemap.test.png", height=5, width=5, units="in", res=300)
par(oma=c(3,3,0,0))
ggmap(map2)+
  geom_point(aes(x=longitude, y=latitude), data=Hak.gps, alpha=0.5, color="dodgerblue", size=1)+
  labs(x="Longitude", y="Latitude")
dev.off()

# AK or RK only
AK<- Hak.gps[(Hak.gps$Site=="AK"),]
RK<- Hak.gps[(Hak.gps$Site=="RK"),]

####### AK map
AK.gps<-c(-155.3189, lat=19.8219)
mapAK<-get_map(AK.gps,
              zoom=20, 
              scale = 2, 
              maptype= "satellite",
              source="google", extent= "device", legend="topright")
AK.map<-ggmap(mapAK, group=type)+
  geom_point(aes(x=longitude, y=latitude, shape=type, color=type), data=AK, alpha=0.5, size=3)+
  theme(legend.position="top",
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    legend.key = element_rect(fill = "white")) +
  guides(colour= guide_legend(override.aes = list(color = "white"))) +
  scale_color_manual(values=c('red','mediumseagreen'))+
  labs(x="Longitude", y="Latitude") + ggtitle("AK-Aforested")


####### RK map
RK.gps<-c(-155.315, 19.8216)
mapRK<-get_map(RK.gps,
               zoom=20, 
               scale = 2, 
               maptype= "satellite",
               source="google", extent= "device", legend="topright")
RK.map<-ggmap(mapRK, group=type)+
  geom_point(aes(x=longitude, y=latitude, shape=type, color=type), data=RK, alpha=0.5, size=3)+
  scale_color_manual(values=c('red','mediumseagreen', "dodgerblue"))+
  scale_shape_manual(values=c(16, 17, 3))+
  theme(legend.position="top",
        legend.title=element_blank(), 
        legend.key = element_rect(fill = "white"))+
  labs(x="Longitude", y="") + ggtitle("RK-Remnant")

### export it
png(file= "figures/RK.AK.sitemaps.png", height=5, width=9, units="in", res=300)
grid.arrange(AK.map, RK.map, ncol = 2)
dev.off()

```

#### Ecology and Isotopes data
```{r, isotope data}
Hak.df<-read.csv("data/Hakalau.isotopes.csv")

########## DBH 
DBH.df<- Hak.df %>%
  select(c(DBH..cm.1, DBH..cm.2, DBH..cm.3, DBH..cm.4, DBH..cm.5))

# replace NAs with zeros
DBH.df<- DBH.df %>%
  mutate_each(funs(replace(., which(is.na(.)), 0)))

# if only one trunk, then make new column and report this value
DBH.df <- DBH.df %>%
  mutate(DBH.1trunk = ifelse(DBH..cm.2>"0", 0, DBH..cm.1))

# if multiple trunks, sum of squares and square root all trunks
# and plug in the DBH for single trunks
DBH.df <- DBH.df %>%
  mutate(DBH.Total = ifelse(DBH.1trunk=="0",  
                     sqrt(DBH..cm.1^2 + DBH..cm.2^2 + DBH..cm.3^2 + DBH..cm.4^2 + DBH..cm.5^2), DBH.1trunk))

# replace zeros with NA now that total DBH has been calculated
DBH.df$DBH.Total<-as.numeric(ifelse(DBH.df$DBH.Total=="0", "NA", DBH.df$DBH.Total))

############ Canopy diameter
# use area of an elipse, a x b x π, where a and b are major and minor radius
Can.df<-Hak.df %>%
  select(c(canopy.0..m, canopy.90..m, canopy.180..m, canopy.270..m))

# Major radius is the average of 0 and 180 degrees
Can.df<- Can.df %>% 
  mutate(Maj.rad = rowMeans(cbind(canopy.0..m, canopy.180..m), na.rm=T))

# Minor radius is the average of 90 and 270 degrees
Can.df<- Can.df %>% 
  mutate(Min.rad = rowMeans(cbind(canopy.90..m, canopy.270..m), na.rm=T))

# Elipse area
Can.df<- Can.df %>% 
  mutate(Canopy.area = ifelse(Maj.rad>0, Maj.rad*Min.rad*3.14, "NA"))

########################
# combine DBH.Total and Canopy.area with isotope dataframe and reduce columns
Hak.df$DBH.Total<-DBH.df$DBH.Total
Hak.df$Canopy.area<-Can.df$Canopy.area

# iso.data is the full dataframe
iso.data<- Hak.df %>%
  select(c(Plot, Sample, DBH.Total, Canopy.area, d15N, d13C, N..percent, Total.N..mmol.gdw, C..percent, Total.C..mmol.gdw, C.N))

########################
########################
########################

# test plots

### Scatter of d13C vs. d15N
iso.scatter<-ggplot(data=iso.dat, aes(x=d13C, y=d15N, color=Plot, shape=Sample))+
  geom_point(cex=1.5) +
  xlab(expression(paste(delta^{13}, C, " (\u2030, V-PDB)"))) +
  ylab(expression(paste(delta^{15}, N, " (\u2030, air)"))) 

### Scatter of total C vs. total N
total.nut<-ggplot(data=iso.dat, aes(x=Total.C..mmol.gdw, y=Total.N..mmol.gdw, color=Plot, shape=Sample))+
  geom_point(cex=1.5) +
  xlab("total Carbon") +
  ylab("total Nitrogen")

#  figures together
plot_grid(iso.scatter, total.nut,
     labels=c('a', 'b'), label_size=10, hjust=-1, vjust= 3, ncol=2, nrow=1)
dev.copy(pdf, "figures/scatter.data.pdf", width=7, height=4, encod="MacRoman")
dev.off()
```


```{r, d15N and DBH and Canopy}
######## plot of d15N and DBH, and d15N and Canopy area

# all samples

par(mfrow=c(1,2), mar=c(4,5,1,1))

#### DBH
mod.DBH<-lm(d15N~DBH.Total+Plot, data=iso.data)
int<-coef(summary(mod.DBH))[1]
DBH.slope<-coef(summary(mod.DBH))["DBH.Total",1] # DBH (slope for all figures)
RK.int<-coef(summary(mod.DBH))["PlotRK",1] # RK, AK = 0


    # no significant relationship to d15N but a trend for DECREASE with DBH
plot(d15N~DBH.Total, data=iso.data,
    col=c("salmon","lightseagreen")[as.factor(Plot)],
    pch=c(1,2)[as.factor(Plot)],
    ylab=expression(paste(delta^{15}, N, " (\u2030, air)")),
    xlab="DBH (cm)",
    ylim=c(0,5), xlim=c(0,60))
    ablineclip(int, DBH.slope, col="coral", lwd=2, 
               x1 = min(iso.data$DBH.Total[iso.data$Plot=="AK"], na.rm=T), 
               x2 = max(iso.data$DBH.Total[iso.data$Plot=="AK"], na.rm=T)) # AK model
    ablineclip((int+ RK.int), DBH.slope, col="lightseagreen", lwd=2, 
               x1 = min(iso.data$DBH.Total[iso.data$Plot=="RK"], na.rm=T), 
               x2 = max(iso.data$DBH.Total[iso.data$Plot=="RK"], na.rm=T)) # RK model

    
#### Canopy
mod.Can<-lm(d15N~Canopy.area+Plot, data=iso.data)
int<-coef(summary(mod.DBH))[1]
Can.slope<-coef(summary(mod.Can))["Canopy.area",1] # DBH (slope for all figures)
RK.int<-coef(summary(mod.Can))["PlotRK",1] # RK, AK = 0

# no significant relationship to d15N but a trend for INCREASE with canopy area
plot(d15N~Canopy.area, data=iso.data, yaxt="n",
     col=c("salmon","lightseagreen")[as.factor(Plot)],
     pch=c(1,2)[as.factor(Plot)],
     xlab=expression(paste("Canopy (m"^2,")")),
     ylab="", 
     ylim=c(0,5), xlim=c(0,80))
     axis(side=2, labels=F)
     ablineclip(int, Can.slope, col="salmon", lwd=2, 
               x1 = min(iso.data$Canopy.area[iso.data$Plot=="AK"], na.rm=T), 
               x2 = max(iso.data$Canopy.area[iso.data$Plot=="AK"], na.rm=T)) # AK model
     ablineclip((int+ RK.int), Can.slope, col="lightseagreen", lwd=2, 
               x1 = min(iso.data$Canopy.area[iso.data$Plot=="RK"], na.rm=T), 
               x2 = max(iso.data$Canopy.area[iso.data$Plot=="RK"], na.rm=T)) # RK model
     legend("topright", legend=levels(iso.data$Plot), box.lty=0, bg="transparent", lty=1, pch=c(1,2), 
            col=c("salmon", "lightseagreen"), cex=1)

dev.copy(pdf, "figures/d15N.DBH.Canopy.pdf", width=7, height=5, encod="MacRoman")
dev.off()
```

```{r mean plots for DBH and Canopy}
DBH.m<-aggregate(DBH.Total~Plot, data=iso.data, mean)
Can.m<-aggregate(Canopy.area~Plot, data=iso.data, mean)

DBH.SE<-aggregate(DBH.Total~Plot, data=iso.data, std.error)
Can.SE<-aggregate(Canopy.area~Plot, data=iso.data, std.error)

mean.eco<-cbind(DBH.m, Can.m[2], DBH.SE[2], Can.SE[2]); colnames(mean.eco)<-c("Plot", "DBH", "Can", "D.SE", "C.SE")

# format #
BW.back<-theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

### DBH plot of mean/SE by plot
DBH.plot<-ggplot(data=mean.eco, aes(x=Plot, y=DBH))+
  geom_bar(stat="identity", position = pd, width=0.7, fill="lightsalmon", alpha=0.7)+
  geom_errorbar(aes(ymin=DBH-D.SE, ymax=DBH+D.SE), size=.5, width=0, position=pd) +
  xlab("Plots") +
  ylab("DBH (cm)") + BW.back

### Canopy plot of mean/SE by plot
Canopy.plot<-ggplot(data=mean.eco, aes(x=Plot, y=Can))+
  geom_bar(stat="identity", position = pd, width=0.7, fill="lightseagreen", alpha=0.8)+
  geom_errorbar(aes(ymin=Can-C.SE, ymax=Can+C.SE), size=.5, width=0, position=pd) +
  xlab("Plots") +
  ylab(expression(paste("Canopy (m"^2,")"))) + BW.back

#  figures together
plot_grid(DBH.plot, Canopy.plot,
     labels=c('a', 'b'), label_size=10, hjust=-1, vjust= 3, ncol=2, nrow=1)
dev.copy(pdf, "figures/DBHCanopy.means.pdf", width=7, height=4, encod="MacRoman")
dev.off()


```

```{r, scatter plots of isotope data}
## make some means and SE
d13C.m<-aggregate(d13C~Plot+Sample, data=iso.dat, mean)
d15N.m<-aggregate(d15N~Plot+Sample, data=iso.dat, mean)
TN.m<-aggregate(Total.N..mmol.gdw~Plot+Sample, data=iso.dat, mean)
TC.m<-aggregate(Total.C..mmol.gdw~Plot+Sample, data=iso.dat, mean)

d13C.SE<-aggregate(d13C~Plot+Sample, data=iso.dat, std.error)
d15N.SE<-aggregate(d15N~Plot+Sample, data=iso.dat, std.error)
TN.SE<-aggregate(Total.N..mmol.gdw~Plot+Sample, data=iso.dat, std.error)
TC.SE<-aggregate(Total.C..mmol.gdw~Plot+Sample, data=iso.dat, std.error)

mean.data<- cbind(d13C.m, d15N.m[3], TN.m[3], TC.m[3], d13C.SE[3], d15N.SE[3], TN.SE[3], TC.SE[3])
colnames(mean.data)<-c("Plot", "Sample", "d13C.mean", "d15N.mean", "TN.mean", "TC.mean", "d15N.SE", "d13C.SE", "TN.SE", "TC.SE")


### make mean plots
pd <- position_dodge(0.7) #offset for error bars

### d13C
d13C.plot<-ggplot(data=mean.data, aes(x=Plot, y=d13C.mean, fill=Sample, group=Sample))+
  geom_bar(stat="identity", position = pd, width=0.7)+
  geom_errorbar(aes(ymin=d13C.mean-d13C.SE, ymax=d13C.mean+d13C.SE), size=.5, width=0, position=pd) +
  scale_fill_manual(values=c('skyblue1','mediumseagreen', "seagreen", "goldenrod")) +
  xlab("Plots") +
  ylab(expression(paste(delta^{13}, C, " (\u2030, V-PDB)")))

### d15N
d15N.plot<-ggplot(data=mean.data, aes(x=Plot, y=d15N.mean, fill=Sample, group=Sample))+
  geom_bar(stat="identity", position = pd, width=0.7)+
  geom_errorbar(aes(ymin=d15N.mean-d15N.SE, ymax=d15N.mean+d15N.SE), size=.5, width=0, position=pd) +
  scale_fill_manual(values=c('skyblue1','mediumseagreen', "seagreen", "goldenrod")) +
  xlab("Plots") +
  ylab(expression(paste(delta^{15}, N, " (\u2030, air)")))

### total Carbon
TC.plot<-ggplot(data=mean.data, aes(x=Plot, y=TC.mean, fill=Sample, group=Sample))+
  geom_bar(stat="identity", position = pd, width=0.7)+
  geom_errorbar(aes(ymin=TC.mean-TC.SE, ymax=TC.mean+TC.SE), size=.5, width=0, position=pd) +
  scale_fill_manual(values=c('skyblue1','mediumseagreen', "seagreen", "goldenrod")) +
  xlab("Plots") +
  ylab("Total Carbon")

### total Nitrogen
TN.plot<-ggplot(data=mean.data, aes(x=Plot, y=TN.mean, fill=Sample, group=Sample))+
  geom_bar(stat="identity", position = pd, width=0.7)+
  geom_errorbar(aes(ymin=TN.mean-TN.SE, ymax=TN.mean+TN.SE), size=.5, width=0, position=pd) +
  scale_fill_manual(values=c('skyblue1','mediumseagreen', "seagreen", "goldenrod")) +
  xlab("Plots") +
  ylab("Total Nitrogen")

#  figures together
plot_grid(d13C.plot, d15N.plot, TC.plot, TN.plot,
     labels=c('a', 'b', 'c', 'd'), label_size=10, hjust=-1, vjust= 3, ncol=2, nrow=2)
dev.copy(pdf, "figures/mean.data.plots.pdf", width=7, height=7, encod="MacRoman")
dev.off()
```


```{r, stats on responses}
#########
# models

## tests for assumptions
for(i in c(8:10,12:15)){
  Y<-iso.dat[,i]
  full<-lm(Y~Plot*Sample, data=iso.dat, na.action=na.exclude)
  R <- resid(full) #save glm residuals
 
  op<-par(mfrow = c(2,3), mar=c(5,4,1,2), pty="sq")
  plot(full, add.smooth = FALSE, which=1)
  QQ <- qqnorm(R, main = colnames(iso.dat)[i]) 
  QQline <- qqline(R)
  hist(R, xlab="Residuals", main = colnames(iso.dat)[i])
  plot(iso.dat$Plot, R, xlab=colnames(iso.dat)[i], ylab="Residuals")
  plot(iso.dat$Sample, R, xlab=colnames(iso.dat)[i], ylab="Residuals")
}

######## ######## 
######## Carbon isotopes

d13C.lm<-lm(d13C~Plot*Sample, data=iso.dat)
d13C.av<-(aov(d13C.lm)); summary(d13C.av) # Plot and Sample effects
plot(allEffects(d13C.lm)) # 2-way interaction
plot(allEffects(lm(d13C~Plot+Sample, data=iso.dat))) # main effects

tukey<-TukeyHSD(d13C.av); tukey
# d13C: Plots differ (Ak vs Rk), Samples differ (as expected)
# posthocs of plot:sample (without main effects)....
# show: Rk koa:Ak koa (sign.), Rk soil:Ak soil (sign.), Ak Rub:Rk Rub (signif.), 
# but koa and Rubus not different from each other in either plots

# main effects-- all plants the same, but differnt from soil

######## ######## 
######## Nitrogen isotopes

d15N.lm<-lm(d15N~Plot*Sample, data=iso.dat)
d15N.av<-(aov(d15N.lm)); summary(d15N.av) # Plot and Sample effects
plot(allEffects(d15N.lm)) # 2-way interaction
plot(allEffects(lm(d15N~Plot+Sample, data=iso.dat))) # main effects

tukey<-TukeyHSD(d15N.av); tukey
# d15N: Plots differ (Ak vs Rk), Samples differ (as expected)
# posthocs of plot:samples (without main effects)...
# show: 
# Rk koa:Ak koa (NOT sign.),  Rk soil:Ak soil (NOT sign.), Ak Rub:Rk Rub (sign.)

# main effects-- Koa diff invasive Rubus, but not native one

######## ######## 
######## Carbon content

TC.lm<-lm(Total.C..mmol.gdw~Plot*Sample, data=iso.dat)
TC.av<-(aov(TC.lm)); summary(TC.av) # Sample and Plot effects
plot(allEffects(lm(Total.C..mmol.gdw~Plot + Sample, data=iso.dat))) # higher in RK and Koa
tukey<-TukeyHSD(TC.av); tukey

######## ######## 
######## Nitrogen content

TN.lm<-lm(Total.N..mmol.gdw~Plot*Sample, data=iso.dat)
TN.av<-(aov(TN.lm)); summary(TN.av) # Sample effects
plot(allEffects(lm(Total.N..mmol.gdw~Sample, data=iso.dat))) # main effects
tukey<-TukeyHSD(TN.av); tukey

######## ######## 
######## Nitrogen content

CN.lm<-lm(C.N~Plot*Sample, data=iso.dat)
CN.av<-(aov(CN.lm)); summary(CN.av) # Plot Sample effects
plot(allEffects(lm(C.N~Plot +Sample, data=iso.dat))) # main effects
tukey<-TukeyHSD(CN.av); tukey

```

```{r}
# load data
krig<-read.csv("data/kriging.matrix.csv") # matrix of points for isoscape grid

# merge kriging data with isotope data
data.merge<-as.data.frame(join_all(list(iso.dat, krig), by = "Position.point", type='full'))

data.merge<-data.merge[c(-167:-194),] # drop NAs where no samples taken
scape.data<-data.merge
write.csv(scape.data, "output/scape.data.csv")

#################
################# make site maps based on bubble plots

# just AK site
krig.AK<- scape.data %>% filter(Plot=="AK")

AK.map<-krig.AK %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + geom_point(aes(size=d15N, color=Sample), alpha=3/4) + 
  ggtitle("AK plot--d15N (permil)") + coord_equal() + theme_bw()

# just RK site
krig.RK<- scape.data %>% filter(Plot=="RK")
 
RK.map<-krig.RK %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + geom_point(aes(size=d15N, color=Sample), alpha=3/4) +
  ggtitle("RK plot--d15N (permil)") + coord_equal() + theme_bw()

plot_grid(RK.map, AK.map, ncol=2, nrow=1)
dev.copy(pdf, "figures/dot.scape.pdf", width=9, height=4, encod="MacRoman")
dev.off()

#####################
#####################

## Krig AK site 
coordinates(krig.AK)<- ~x.meter + y.meter
col.scheme.N <- colorRampPalette(c('red', 'darkseagreen2', 'gray5'))(5)

Grid.AK <- spsample(krig.AK, type='regular', n=1e5)
gridded(Grid.AK) <- TRUE

## d15N full plot
d15N.krig.AK <- krige(d15N ~ 1, krig.AK, Grid.AK) # ordinary kriging
plot(variogram(d15N ~ 1, krig.AK)) # variogram

plotd15N.krig.AK<-spplot(d15N.krig.AK["var1.pred"], col.regions=colorRampPalette(col.scheme.N), 
       main=expression(paste(delta^{15}, N, "--AK (Afforested Koa Plot)")))

#####################
## Krig RK site
coordinates(krig.RK)<- ~x.meter + y.meter
GridRK <- spsample(krig.RK, type='regular', n=1e5)
gridded(GridRK) <- TRUE

## d15N plot
d15N.krig.RK <- krige(d15N ~ 1, krig.RK)
plot(variogram(d15N ~ 1, krig.AK))

plotd15N.krig.RK<-spplot(d15N.krig.RK["var1.pred"], col.regions=colorRampPalette(col.scheme.N), 
       main=expression(paste(delta^{15}, N, "--RK (Remnant Koa Plot)")))

#####################
### combined Ak-Rk krig d15N plot 
plot_grid(plotd15N.krig.RK, plotd15N.krig.AK, ncol=2, nrow=1)
dev.copy(pdf, "figures/RKAK.d15N.krig.pdf", width=7, height=4, encod="MacRoman")
dev.off()

```

```{r}

## d15N koa plot
krig.AK<- scape.data %>% filter(Plot=="AK") # just AK

KOA.AK<-  krig.AK[c(krig.AK$Sample=="Koa"),] #just Koa

coordinates(KOA.AK)<- ~x.meter + y.meter # coordinate system

# create sequences that represent the center of the columns of pixels
# change "by" to change the resolution of the raster
Columns=seq(from=1, to=35, by=0.1)

# And the rows of pixels:
Rows=seq(from=1, to=20, by=0.1)

# Create a grid of "Pixels" using x as columns and y as rows
Grid.KOA.AK <- expand.grid(x=Columns,y=Rows)

# Convert Thegrid to a SpatialPixel class
coordinates(Grid.KOA.AK) <- ~ x+y
gridded(Grid.KOA.AK) <- TRUE

d15N.KOA.AK <- autoKrige(d15N ~ 1, KOA.AK, Grid.KOA.AK) # ordinary kriging
plot(d15N.KOA.AK)
plot(variogram(d15N ~ 1, KOA.AK)) # variogram

d15N.KOA.AK2 <- krige(d15N ~ 1, KOA.AK, Grid.KOA.AK) # ordinary kriging
plotd15N.koa.krig.AK2<-spplot(d15N.KOA.AK2["var1.pred"], col.regions=colorRampPalette(col.scheme.N), 
       main=expression(paste(delta^{15}, N, "--AK (Afforested Koa Plot)")))


##############
krig.RK<- scape.data %>% filter(Plot=="RK") # just RK
KOA.RK<-  krig.RK %>% filter(Sample=="Koa") #just Koa

coordinates(KOA.RK)<- ~x.meter + y.meter # coordinate system

Columns=seq(from=1, to=20, by=0.1)
Rows=seq(from=1, to=35, by=0.1)
Grid.KOA.RK <- expand.grid(x=Columns,y=Rows)

# Convert Thegrid to a SpatialPixel class
coordinates(Grid.KOA.RK) <- ~ x+y
gridded(Grid.KOA.RK) <- TRUE

d15N.KOA.RK <- autoKrige(d15N ~ 1, KOA.RK, Grid.KOA.RK) # ordinary kriging
plot(d15N.KOA.RK)
plot(variogram(d15N ~ 1, KOA.RK)) # variogram

d15N.KOA.RK2 <- krige(d15N ~ 1, KOA.RK, Grid.KOA.RK) # ordinary kriging
plotd15N.koa.krig.RK<-spplot(d15N.KOA.RK2["var1.pred"], col.regions=colorRampPalette(col.scheme.N), 
       main=expression(paste(delta^{15}, N, "--RK (Remnant Koa Plot)")))

```


```{r, eval=FALSE}
#####################
# Carbon kriging, leave alone for now.
#####################

## Krig AK site d13C
coordinates(krig.AK)<- ~x.meter + y.meter
col.scheme.C <- colorRampPalette(c('coral', 'cadetblue2', 'gray5'))(5)

Grid.AK <- spsample(krig.AK, type='regular', n=1e5)
gridded(Grid.AK) <- TRUE

## d13C plot
d13C.krig.AK <- krige(d13C ~ 1, krig.AK, Grid.AK)
plotd13C.krig.AK<-spplot(d13C.krig.AK["var1.pred"], col.regions=colorRampPalette(col.scheme.C), 
       main=expression(paste(delta^{13}, C, "--AK (Afforested Koa Plot)")))

## Krig RK site d13C
coordinates(krig.RK)<- ~x.meter + y.meter
GridRK <- spsample(krig.RK, type='regular', n=1e5)
gridded(GridRK) <- TRUE

## d13C plot
d13C.krig.RK <- krige(d13C ~ 1, krig.RK, GridRK)
plotd13C.krig.RK<-spplot(d13C.krig.RK["var1.pred"], col.regions=colorRampPalette(col.scheme.C), 
       main=expression(paste(delta^{13}, C, "--RK (Remnant Koa Plot)")))


```
```






```{r, kriging test, include=FALSE}
### Testing Kriging
################################################

# load data
krig<-read.csv("data/kriging.test.csv")

# simulate data
krig <- krig %>% 
  mutate(d15N.ex = as.numeric(rnorm(n=166, mean=2, sd=3)))

# just AK site
krig.AK<- krig %>% filter(site=="AK")

# example map with 
krig.AK %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter)) + geom_point(aes(size=d15N.ex), color="forestgreen", alpha=3/4) + 
  ggtitle("d15N simulated (permil)") + coord_equal() + theme_bw()


# convert to spatial data, now a SPDF class object with 5 data slots
coordinates(krig.AK)<- ~x.meter + y.meter
str(krig.AK)
# data: contains all the variables associated with different spatial locations
# coords slot:  a matrix of all spatial locations with corresponding values
# bbox:  the bounding box or the 4 corners denoting spatial extent
# proj4string: projection inform. ie., what are the coordinates in?

# can coerce back to dataframe for plotting etc
# krig.AK<-krig.AK %>% as.data.frame %>% glimpse


##### VARIOGRAM, must be the SPDF object
# variogram function can take two arguments: 
# first: how one or more variables interact spatially
# second: SPDF object where those variables reside.


# no trend variogram
# example: variogram(log(zinc)~1, meuse)
vario.notrend <- variogram(d15N.ex~1, krig.AK)

# residual variogram w.r.t. a linear trend:
# example variogram(log(zinc)~x+y, meuse)
vario.resid <- variogram(d15N.ex~x.meter+y.meter, krig.AK) # calculates sample variogram values

# directional variogram:
# example: variogram(log(zinc)~x+y, meuse, alpha=c(0,45,90,135))
# example: variogram(log(zinc)~1, meuse, width=90, cutoff=1300)
vario.dir1 <- variogram(d15N.ex~x.meter+y.meter, krig.AK, alpha=c(0,45,90,135))
vario.dir2 <- variogram(d15N.ex~1, krig.AK, width=90, cutoff=1300)


######### fitting the variogram 
# first: variogram testing
# second: model with parameters to be fit to sample variogram
vario.fit <- fit.variogram(vario.resid, model=vgm(1, "Sph", 900, 1)) # fit model

plot(vario.resid, vario.fit) # plot the sample values, along with the fit model


##########################
# Kriging 

# need to make a grid to match where kriging/estimation is done

grid<-makegrid(krig.AK, n=1000)
colnames(grid)<-c('x.meter', 'y.meter')
grid<-as.data.frame(grid)

#where we have measurements
plot1 <- krig.AK %>% as.data.frame %>%
  ggplot(aes(x.meter, y.meter)) + geom_point(size=1) + coord_equal() + 
  ggtitle("Points with measurements")

# where we WANT measurements
plot2 <- grid %>% as.data.frame %>%
  ggplot(aes(x.meter, y.meter)) + geom_point(size=0.5) + coord_equal() + 
  ggtitle("Points at which to estimate")

#### make the plots
grid.arrange(plot1, plot2, ncol = 2)

# Once we have the prepared all of the above, we are now ready to krige. This can be done with the gstat::krige function, which usually takes four arguments:
# The model formula.
#  An SPDF of the spatial domain that has measurements.
#  An SPDF of the spatial domain to krige over.
#  A variogram model fitted to the data.
# Note that the second and third arguments have to be SPDF’s and cannot just be dataframes.


# make coordinates for grid (as we did for test data)
coordinates(grid)<- ~ x.meter + y.meter

# fit the model for the krig object (grid) and use model fit from corresponding model data above
test.krig<-krige(d15N.ex~1, krig.AK, grid, model=vario.fit)

test.krig %>% as.data.frame %>%
  ggplot(aes(x=x.meter, y=y.meter)) + geom_tile(aes(fill=var1.pred)) + coord_equal() +
  scale_fill_gradient(low = "yellow", high="red") +
  scale_x_continuous(labels=comma) + scale_y_continuous(labels=comma) +
  theme_bw()
```



```{r}


```


```{r}

```

